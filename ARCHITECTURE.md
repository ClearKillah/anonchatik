# Архитектура приложения Anonchatik

Этот документ описывает архитектуру приложения Anonchatik, анонимного чата для Telegram Mini App.

## Общая архитектура

Приложение Anonchatik построено по клиент-серверной архитектуре:

1. **Клиентская часть** - React-приложение, которое работает в Telegram Mini App.
2. **Серверная часть** - Node.js сервер с Express и Socket.IO для обработки WebSocket соединений.

```
+-------------------+        WebSocket        +-------------------+
|                   |  <------------------->  |                   |
|  Клиент (React)   |                         |  Сервер (Node.js) |
|  Telegram Mini App|                         |  Express+Socket.IO|
|                   |                         |                   |
+-------------------+                         +-------------------+
```

## Клиентская архитектура

Клиентская часть построена на React с использованием функциональных компонентов и хуков.

### Основные компоненты

```
App.js
  ├── StartScreen.js
  ├── WaitingScreen.js
  └── ChatScreen.js
       ├── Message.js
       └── MessageInput.js
```

### Состояние приложения

Состояние приложения управляется через хук `useSocket.js`, который обрабатывает все взаимодействия с сервером через WebSocket.

```
useSocket.js
  ├── Состояние соединения
  ├── Состояние чата
  ├── Сообщения
  └── Методы взаимодействия с сервером
```

### Жизненный цикл клиента

1. **Инициализация**: Пользователь открывает приложение, загружается `App.js`.
2. **Регистрация**: Пользователь нажимает кнопку "Начать чат" на `StartScreen.js`, отправляется запрос на регистрацию.
3. **Ожидание**: Отображается `WaitingScreen.js`, пока сервер ищет собеседника.
4. **Чат**: После нахождения собеседника отображается `ChatScreen.js`, где пользователь может отправлять и получать сообщения.
5. **Завершение**: Пользователь может пропустить собеседника или закрыть приложение.

## Серверная архитектура

Серверная часть построена на Node.js с использованием Express для HTTP и Socket.IO для WebSocket.

### Основные компоненты сервера

```
server.js
  ├── Express сервер
  ├── Socket.IO сервер
  ├── Обработчики событий Socket.IO
  └── Хранилище данных в памяти
```

### Хранилище данных

Сервер использует структуры данных в памяти для хранения информации о пользователях и чатах:

```javascript
// Хранение пользователей: userId -> socketId
const users = new Map();

// Пользователи, ожидающие собеседника
const waitingUsers = new Set();

// Активные чаты: chatId -> { user1, user2 }
const activeChats = new Map();

// Чаты пользователей: userId -> chatId
const userChats = new Map();
```

### Жизненный цикл сервера

1. **Инициализация**: Сервер запускается, настраивается Express и Socket.IO.
2. **Подключение клиента**: Клиент подключается через WebSocket, создается новое соединение.
3. **Регистрация пользователя**: Клиент отправляет событие `register`, сервер сохраняет информацию о пользователе.
4. **Поиск собеседника**: Клиент отправляет событие `findPartner`, сервер ищет доступного собеседника или добавляет пользователя в очередь ожидания.
5. **Обмен сообщениями**: Клиенты отправляют события `sendMessage`, сервер перенаправляет сообщения между собеседниками.
6. **Пропуск собеседника**: Клиент отправляет событие `skipPartner`, сервер разрывает текущий чат и ищет нового собеседника.
7. **Отключение**: Клиент отключается, сервер очищает данные пользователя и уведомляет собеседника, если он был в активном чате.

## Взаимодействие клиента и сервера

### События WebSocket

| Событие | Направление | Описание |
|---------|-------------|----------|
| `register` | Клиент → Сервер | Регистрация пользователя на сервере |
| `findPartner` | Клиент → Сервер | Запрос на поиск собеседника |
| `chatStarted` | Сервер → Клиент | Уведомление о начале чата |
| `sendMessage` | Клиент → Сервер | Отправка сообщения |
| `receiveMessage` | Сервер → Клиент | Получение сообщения |
| `skipPartner` | Клиент → Сервер | Запрос на пропуск текущего собеседника |
| `partnerLeft` | Сервер → Клиент | Уведомление о выходе собеседника |
| `disconnect` | Клиент → Сервер | Отключение пользователя |

### Формат данных

#### Регистрация пользователя
```javascript
// Клиент → Сервер
socket.emit('register', { userId: 'user123' });
```

#### Начало чата
```javascript
// Сервер → Клиент
socket.emit('chatStarted', { chatId: 'chat123' });
```

#### Отправка сообщения
```javascript
// Клиент → Сервер
socket.emit('sendMessage', { text: 'Привет!' });
```

#### Получение сообщения
```javascript
// Сервер → Клиент
socket.emit('receiveMessage', { 
  text: 'Привет!',
  isOwn: false,
  timestamp: 1621234567890
});
```

## Интеграция с Telegram Mini App

Приложение интегрируется с Telegram Mini App через JavaScript SDK:

```javascript
const tg = window.Telegram.WebApp;
```

### Использование функций Telegram Mini App

1. **Получение данных пользователя**:
   ```javascript
   const user = tg.initDataUnsafe?.user;
   ```

2. **Адаптация к теме Telegram**:
   ```javascript
   const colorScheme = tg.colorScheme; // 'light' или 'dark'
   ```

3. **Управление кнопками**:
   ```javascript
   tg.MainButton.setText('Найти собеседника');
   tg.MainButton.show();
   ```

## Масштабирование и производительность

### Текущие ограничения

1. Данные хранятся в памяти, что ограничивает масштабируемость.
2. Нет постоянного хранения истории сообщений.
3. Один экземпляр сервера может обрабатывать ограниченное количество соединений.

### Возможные улучшения

1. **Масштабирование**:
   - Использование Redis для хранения данных о пользователях и чатах.
   - Горизонтальное масштабирование с использованием балансировщика нагрузки.

2. **Производительность**:
   - Оптимизация алгоритма поиска собеседников.
   - Кеширование часто используемых данных.

3. **Надежность**:
   - Добавление механизма восстановления соединения.
   - Реализация очереди сообщений для обработки пиковых нагрузок.

## Безопасность

1. **Анонимность**:
   - Пользователи идентифицируются только по ID, без передачи личной информации.
   - Нет возможности узнать Telegram ID собеседника.

2. **Защита от атак**:
   - Валидация входящих данных.
   - Ограничение частоты запросов.
   - CORS настройки для предотвращения несанкционированного доступа.

3. **Шифрование**:
   - WebSocket соединение через HTTPS.
   - Данные пользователя не сохраняются на сервере после завершения сессии.

## Заключение

Архитектура Anonchatik обеспечивает простое и эффективное решение для анонимного общения в Telegram. Клиент-серверная модель с использованием WebSocket позволяет создать отзывчивый интерфейс с минимальной задержкой при обмене сообщениями.

Текущая реализация подходит для небольшого и среднего количества пользователей. Для масштабирования до большего количества пользователей потребуются дополнительные оптимизации и изменения в архитектуре хранения данных. 